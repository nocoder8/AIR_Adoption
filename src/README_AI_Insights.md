# AI-Powered Observations Feature for AIR Daily Summary Report

This document describes the AI-Powered Observations feature integrated into the `AIR_DailySummary.js` Google Apps Script. This feature leverages the Google Gemini API to provide automated analysis and insights based on the data compiled in the daily summary report.

## Table of Contents
1.  [Purpose](#purpose)
2.  [Core Components](#core-components)
3.  [Setup & Configuration](#setup--configuration)
    *   [Gemini API Key](#gemini-api-key)
4.  [How it Works](#how-it-works)
5.  [Customization](#customization)
    *   [Modifying Data Summary for AI](#modifying-data-summary-for-ai)
    *   [Refining the AI Prompt](#refining-the-ai-prompt)
    *   [Adjusting Data Thresholds](#adjusting-data-thresholds)
    *   [Changing AI Generation Parameters](#changing-ai-generation-parameters)
    *   [Modifying Insight Formatting](#modifying-insight-formatting)
6.  [Troubleshooting](#troubleshooting)
7.  [Dependencies](#dependencies)

## 1. Purpose
The AI-Powered Observations feature aims to automatically generate concise, data-driven insights from the daily AI Recruiter (AIR) report. It highlights key trends, performance variations across recruiters, job functions, and countries, and areas that may require attention, thereby adding a layer of automated analysis to the report.

## 2. Core Components
This feature is primarily implemented through the following functions in `AIR_DailySummary.js`:

*   **`fetchInsightsFromGeminiAPI(metrics, adoptionChartData, recruiterActivityData)`**:
    *   Responsible for constructing a summarized text payload from the report's metrics.
    *   Sends this summary along with a carefully crafted prompt to the Google Gemini API.
    *   Receives the textual insights generated by the AI.
*   **`formatInsightsForHtml(insightsText, metrics)`**:
    *   Takes the raw text insights from the Gemini API.
    *   Formats them for HTML display by:
        *   Bolding known entity names (recruiters, job functions, countries) extracted from the `metrics` object.
        *   Bolding percentage values.
        *   Converting newline characters to HTML line breaks (`<br>`).
*   **Integration within `createRecruiterBreakdownHtmlReport(...)`**:
    *   This main report generation function calls `fetchInsightsFromGeminiAPI` to get the insights.
    *   It then calls `formatInsightsForHtml` to prepare the insights for display.
    *   The formatted insights are embedded into a dedicated section of the HTML email report.

## 3. Setup & Configuration

### Gemini API Key
This feature requires a Google Gemini API key.

1.  **Obtain an API Key**:
    *   Go to [Google AI Studio](https://aistudio.google.com/).
    *   Sign in with your Google Account.
    *   Follow the prompts to "Get API key" or "Create API key" (you might need to create a new project).
    *   Copy the generated API key. **Treat this key like a password and keep it secure.**
2.  **Store the API Key in Script Properties**:
    *   In the Google Apps Script editor for `AIR_DailySummary.js`, go to **Project Settings** (⚙️ icon on the left).
    *   Scroll to the **Script Properties** section.
    *   Click **"Add script property"**.
    *   Set the **Property** name to: `GEMINI_API_KEY`
    *   Paste your copied Gemini API key into the **Value** field.
    *   Click **"Save script properties"**.

The script will not be able to generate AI insights if the `GEMINI_API_KEY` is not correctly configured.

## 4. How it Works
1.  The `AIR_DailySummarytoAP` function calculates various metrics and data breakdowns.
2.  When `createRecruiterBreakdownHtmlReport` is called, it invokes `fetchInsightsFromGeminiAPI`.
3.  `fetchInsightsFromGeminiAPI`:
    *   Retrieves the `GEMINI_API_KEY` from Script Properties.
    *   Constructs a detailed textual summary (`dataSummary`) of key metrics, including overall performance, recruiter performance (high/low completion, activity, recent inactivity), job function performance (high/low completion, volume), country performance (high/low completion, volume), and AI adoption rates.
    *   Creates a `promptText` instructing the Gemini API on how to analyze the `dataSummary` and what kind of insights to generate (e.g., focus on best/worst, name specifics, provide actionable points).
    *   Makes a POST request to the Gemini API endpoint (`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent`) using `UrlFetchApp.fetch()`.
    *   Parses the API's JSON response to extract the generated text.
4.  The raw insights text is then passed to `formatInsightsForHtml`.
5.  `formatInsightsForHtml` bolds known entity names (recruiters, job functions, countries found in the `metrics` data) and percentages, and converts newlines to `<br>` tags.
6.  The formatted HTML insights are then inserted into the email report.

## 5. Customization

### Modifying Data Summary for AI
The quality and focus of the AI insights heavily depend on the `dataSummary` string built within the `fetchInsightsFromGeminiAPI` function. To change what the AI focuses on:
*   Locate the `// 1. Summarize your data` section in `fetchInsightsFromGeminiAPI`.
*   Modify or add to the logic that appends data to the `dataSummary` variable. For instance, to highlight different aspects of recruiter performance or include data from other `metrics` fields.

### Refining the AI Prompt
The `promptText` variable in `fetchInsightsFromGeminiAPI` guides the AI.
*   Modify this string to change the AI's instructions, such as the number of bullet points, the tone, or specific areas of focus.
*   Example: You could ask for insights on a *very specific* metric if you ensure that metric is clearly presented in the `dataSummary`.

### Adjusting Data Thresholds
Several thresholds are used in `fetchInsightsFromGeminiAPI` to make summaries more meaningful (e.g., for identifying "lowest" performers):
*   `minSentForLowConsideration` (for recruiters)
*   `inactivityThresholdDays` (for recruiter recent activity)
*   `minSentForConsideration` (for job functions - currently same name as recruiter one, ensure correct variable is used if different values desired)
*   `minSentForCountryConsideration` (for countries)
Adjust these numerical values as needed based on your data volume.

### Changing AI Generation Parameters
Within the `payload` object in `fetchInsightsFromGeminiAPI`, the `generationConfig` section controls aspects of the AI's response:
*   `"temperature"`: (e.g., `0.6`) Controls randomness. Lower values (e.g., 0.2-0.5) make the output more deterministic and focused. Higher values (e.g., 0.7-0.9) make it more "creative" or diverse.
*   `"maxOutputTokens"`: (e.g., `500`) Maximum length of the generated insights.
Adjust these based on desired output style and length.

### Modifying Insight Formatting
The `formatInsightsForHtml` function handles bolding and line breaks.
*   **Bolding Entities**:
    *   To add more types of entities to be bolded (e.g., project names), add logic to push their names into the `knownEntities` array (e.g., from another property in the `metrics` object).
    *   The `filter(e => e.length > 2)` prevents very short strings from being bolded; adjust if needed.
    *   The regex for entity bolding is currently `new RegExp(\`\\b(${escapedEntity})\\b\`, 'gi')` (case-insensitive).
*   **Bolding Percentages**:
    *   The regex is `(\\b\\d+(\\.\\d+)?%\\b)`. Modify if your percentage format differs.

## 6. Troubleshooting
*   **"Could not generate AI insights: API Key not configured..."**: Ensure `GEMINI_API_KEY` is correctly set in Project Settings > Script Properties.
*   **"API Error 503: Service is currently unavailable"**: This is usually a temporary Google-side issue. Wait a few minutes and try running the script again.
*   **Other API Errors (4xx, 5xx)**: The error message in the email/logs should provide details. This could be due to an invalid API key, issues with the request payload (e.g., malformed `dataSummary` or `promptText` leading to safety blocks), or other API issues. Check the `Logger.log` output in Google Apps Script `Executions` for more details.
*   **Names/Entities Not Bolding**:
    *   Verify the entity names exist as keys in `metrics.byRecruiter`, `metrics.byJobFunction`, or `metrics.byCountry`.
    *   The `formatInsightsForHtml` uses case-insensitive matching. Check for subtle differences in names (e.g., extra spaces, special characters not handled by the escape function).
    *   Check the `Logger.log` for any regex errors from `formatInsightsForHtml`.
*   **Insights Not As Expected**:
    *   Review the `dataSummary` string logged during execution. Does it contain the information you expect the AI to use?
    *   Refine the `promptText` to be more specific.
    *   Adjust `temperature` in `generationConfig`.

## 7. Dependencies
*   **Google Gemini API**: Requires a valid API key and network access for `UrlFetchApp`.
*   **Google Apps Script Services**:
    *   `PropertiesService`: For retrieving the API key.
    *   `UrlFetchApp`: For making the HTTP request to the Gemini API.
    *   `Logger`: For debugging.
    *   `MailApp` (used by the main script): For sending the email report. 